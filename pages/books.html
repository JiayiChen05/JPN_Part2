<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Books - Public Affirmation Library</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/theme-toggle.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .book-card-content {
        padding: 1.5rem;
        border-radius: 8px;
        background: var(--bg-secondary);
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .book-card-content h3 {
        margin-top: 0;
        font-size: 1.25rem;
        color: var(--text-primary);
      }
      
      .status-success {
        color: #10b981;
        font-weight: 500;
      }
      
      .status-danger {
        color: #ef4444;
        font-weight: 500;
      }
      
      .no-results {
        grid-column: 1 / -1;
        text-align: center;
        padding: 2rem;
        font-size: 1.1rem;
        color: var(--text-secondary);
      }
      
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      
      .modal-content {
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
      }
      
      .detail-row {
        display: flex;
        margin-bottom: 0.75rem;
      }
      
      .detail-label {
        font-weight: 500;
        width: 35%;
        color: var(--text-secondary);
      }
      
      .detail-value {
        width: 65%;
      }
      
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo">
          <h1>Public Affirmation Library</h1>
        </div>
        <div class="nav-buttons">
          <button
            class="theme-toggle"
            onclick="toggleTheme()"
            aria-label="Toggle theme"
          >
            <svg
              class="sun-icon"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
            >
              <path
                d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM12 21.75a.75.75 0 01-.75-.75v-2.25a.75.75 0 011.5 0V21a.75.75 0 01-.75.75zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM21 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25A.75.75 0 0121 12zM5.78 5.78a.75.75 0 011.06 0l1.5 1.5a.75.75 0 01-1.06 1.06l-1.5-1.5a.75.75 0 010-1.06zM18.22 18.22a.75.75 0 01-1.06 0l-1.5-1.5a.75.75 0 011.06-1.06l1.5 1.5a.75.75 0 010 1.06zM18.22 5.78a.75.75 0 010 1.06l-1.5 1.5a.75.75 0 11-1.06-1.06l1.5-1.5a.75.75 0 011.06 0zM5.78 18.22a.75.75 0 010-1.06l1.5-1.5a.75.75 0 111.06 1.06l-1.5 1.5a.75.75 0 01-1.06 0z"
              />
            </svg>
            <svg
              class="moon-icon"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
            >
              <path
                d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z"
              />
            </svg>
          </button>
          <a href="../index.html" class="btn">Home</a>
          <a href="books.html" class="btn">Books</a>
          <a href="login.html" class="btn">Login</a>
        </div>
      </nav>
    </header>

    <main>
      <div class="hero-section">
        <h2>Library Collection</h2>
        <p>Explore our vast collection of books and resources</p>
      </div>

      <div
        class="container"
        style="max-width: 1200px; margin: 0 auto; padding: 2rem"
      >
        <div class="features-grid" style="margin-bottom: 3rem">
          <div class="feature-card">
            <h3>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path
                  d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                ></path>
              </svg>
              <span id="totalBooks">Loading...</span>
            </h3>
            <p>Total Books</p>
          </div>
          <div class="feature-card">
            <h3>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line>
              </svg>
              <span id="availableBooks">Loading...</span>
            </h3>
            <p>Available Books</p>
          </div>
          <div class="feature-card">
            <h3>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <span id="borrowedBooks">Loading...</span>
            </h3>
            <p>Borrowed Books</p>
          </div>
          <div class="feature-card">
            <h3>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path
                  d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                ></path>
              </svg>
              <span id="categories">Loading...</span>
            </h3>
            <p>Categories</p>
          </div>
        </div>

        <div class="search-filters">
          <div class="form-group" style="flex: 1">
            <input
              type="text"
              id="searchInput"
              class="form-control"
              placeholder="Search by title, author, or ISBN..."
            />
          </div>
          <div class="form-group">
            <select id="categoryFilter" class="form-control">
              <option value="">All Categories</option>
              <!-- Categories will be loaded dynamically -->
            </select>
          </div>
          <div class="form-group">
            <select id="availabilityFilter" class="form-control">
              <option value="">All Availability</option>
              <option value="available">Available</option>
              <option value="borrowed">Borrowed</option>
            </select>
          </div>
        </div>

        <div class="features-grid" id="booksGrid">
          <!-- Books will be loaded dynamically -->
          <div class="loading-message">Loading books...</div>
        </div>
      </div>

      <!-- Book Details Modal -->
      <div id="bookModal" class="modal">
        <div class="modal-content card">
          <div class="modal-header">
            <h2>Book Details</h2>
            <button
              class="theme-toggle"
              onclick="closeModal()"
              aria-label="Close modal"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="book-full-details">
            <div class="detail-row">
              <span class="detail-label">Title:</span>
              <span class="detail-value" id="modalBookTitle"></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Author:</span>
              <span class="detail-value" id="modalAuthor"></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Category:</span>
              <span class="detail-value" id="modalCategory"></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Status:</span>
              <span class="detail-value" id="modalStatus"></span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Available Copies:</span>
              <span class="detail-value" id="modalAvailableCopies"></span>
            </div>
          </div>
          <div class="modal-buttons">
            <button class="btn" onclick="closeModal()">Close</button>
            <button class="btn" id="modalReserveBtn">Reserve Book</button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2024 Public Affirmation Library. All rights reserved.</p>
    </footer>

    <script src="../js/theme-toggle.js"></script>
    <script>
    // API endpoints
    const API = {
      BOOKS_STATS: '../api/books_stats.php',
      SEARCH_BOOKS: '../api/search_books.php',
      GET_BOOK: '../api/get_book.php',
      GET_CATEGORIES: '../api/get_topics.php'
    };
    
    // Load initial data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Load statistics
      loadStatistics();
      
      // Load categories
      loadCategories();
      
      // Load initial books
      searchBooks();
      
      // Add event listeners for search and filters
      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const availabilityFilter = document.getElementById('availabilityFilter');
      
      // Add event listener for input change with debounce
      let debounceTimer;
      searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(searchBooks, 300);
      });
      
      // Add event listeners for select changes
      categoryFilter.addEventListener('change', searchBooks);
      availabilityFilter.addEventListener('change', searchBooks);
    });
    
    // Function to load statistics
    function loadStatistics() {
      // For now, use separate fetch requests for each statistic
      // In a production environment, you'd create a dedicated API endpoint for all stats
      
      // Total books
      fetch('../api/get_books.php?countOnly=true')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('totalBooks').textContent = data.count || 0;
          }
        })
        .catch(error => {
          console.error('Error loading total books:', error);
          document.getElementById('totalBooks').textContent = 'Error';
        });
      
      // Available books
      fetch('../api/get_books.php?countOnly=true&availability=available')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('availableBooks').textContent = data.count || 0;
          }
        })
        .catch(error => {
          console.error('Error loading available books:', error);
          document.getElementById('availableBooks').textContent = 'Error';
        });
      
      // Borrowed books
      fetch('../api/get_books.php?countOnly=true&availability=borrowed')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('borrowedBooks').textContent = data.count || 0;
          }
        })
        .catch(error => {
          console.error('Error loading borrowed books:', error);
          document.getElementById('borrowedBooks').textContent = 'Error';
        });
      
      // Categories
      fetch('../api/get_topics.php?countOnly=true')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('categories').textContent = data.count || 0;
          }
        })
        .catch(error => {
          console.error('Error loading categories:', error);
          document.getElementById('categories').textContent = 'Error';
        });
    }
    
    // Function to load categories
    function loadCategories() {
      fetch('../api/get_topics.php')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.topics && data.topics.length > 0) {
            const categoryFilter = document.getElementById('categoryFilter');
            
            // Keep the default "All Categories" option
            const defaultOption = categoryFilter.querySelector('option');
            categoryFilter.innerHTML = '';
            categoryFilter.appendChild(defaultOption);
            
            // Add each category as an option
            data.topics.forEach(topic => {
              const option = document.createElement('option');
              option.value = topic.T_ID;
              option.textContent = topic.T_NAME;
              categoryFilter.appendChild(option);
            });
          }
        })
        .catch(error => {
          console.error('Error loading categories:', error);
        });
    }
    
    // Function to search books
    function searchBooks() {
      const searchTerm = document.getElementById('searchInput').value;
      const category = document.getElementById('categoryFilter').value;
      const availability = document.getElementById('availabilityFilter').value;
      
      // Build query URL
      let url = '../api/search_books.php?';
      if (searchTerm) url += `query=${encodeURIComponent(searchTerm)}&`;
      if (category) url += `category=${encodeURIComponent(category)}&`;
      if (availability) url += `availability=${encodeURIComponent(availability)}`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            updateBooksList(data.books);
          } else {
            console.error('Search failed:', data.message);
          }
        })
        .catch(error => {
          console.error('Error searching books:', error);
        });
    }
    
    // Function to update the books list with search results
    function updateBooksList(books) {
      const booksGrid = document.getElementById('booksGrid');
      
      // Clear existing books
      booksGrid.innerHTML = '';
      
      if (books.length === 0) {
        booksGrid.innerHTML = '<div class="no-results">No books found matching your criteria.</div>';
        return;
      }
      
      // Add each book to the grid
      books.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'feature-card';
        bookCard.dataset.bookId = book.BOOK_ID;
        
        bookCard.innerHTML = `
          <div class="book-card-content">
            <h3>${escapeHtml(book.BOOK_NAME)}</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem">
              ${escapeHtml(book.AUTHOR_NAME || 'Unknown Author')}
            </p>
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
              <span>${escapeHtml(book.TOPIC_NAME || 'Uncategorized')}</span>
              <span class="${book.AVAILABLE_COPIES > 0 ? 'status-success' : 'status-danger'}">${book.AVAILABLE_COPIES > 0 ? 'Available' : 'Borrowed'}</span>
            </div>
            <div style="display: flex; gap: 1rem">
              ${book.AVAILABLE_COPIES > 0 ? `<a href="#" class="btn" onclick="reserveBook('${book.BOOK_ID}')">Reserve</a>` : ''}
              <a href="#" class="btn" onclick="showBookDetails('${book.BOOK_ID}')">Details</a>
            </div>
          </div>
        `;
        
        booksGrid.appendChild(bookCard);
      });
    }
    
    // Function to get book details from the server
    function showBookDetails(bookId) {
      fetch(`../api/get_book.php?id=${bookId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const book = data.book;
            document.getElementById('modalBookTitle').textContent = book.BOOK_NAME;
            document.getElementById('modalAuthor').textContent = book.AUTHOR_NAME || 'Unknown Author';
            document.getElementById('modalCategory').textContent = book.TOPIC_NAME || 'Uncategorized';
            document.getElementById('modalStatus').textContent = book.AVAILABLE_COPIES > 0 ? 'Available' : 'Borrowed';
            document.getElementById('modalAvailableCopies').textContent = book.AVAILABLE_COPIES;
            
            const reserveBtn = document.getElementById('modalReserveBtn');
            if (book.AVAILABLE_COPIES > 0) {
              reserveBtn.style.display = 'block';
              reserveBtn.onclick = function() { reserveBook(book.BOOK_ID); };
            } else {
              reserveBtn.style.display = 'none';
            }
            
            document.getElementById('bookModal').style.display = 'flex';
          } else {
            alert('Failed to load book details');
          }
        })
        .catch(error => {
          console.error('Error fetching book details:', error);
          alert('An error occurred while fetching book details');
        });
    }

    // Function to reserve a book
    function reserveBook(bookId) {
      // This would typically require a user to be logged in
      alert('Please log in to reserve this book');
      window.location.href = 'login.html';
    }

    // Function to close the modal
    function closeModal() {
      document.getElementById('bookModal').style.display = 'none';
    }
    
    // Helper function to escape HTML
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    </script>
  </body>
</html>
